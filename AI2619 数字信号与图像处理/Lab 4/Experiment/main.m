% window
wl = 1024;
wd = hann(wl, 'periodic');

% raw
[y_raw, fs_raw] = audioread('./wave/raw.wav');
l_raw = length(y_raw);
t_raw = (1: l_raw) ./ fs_raw;
[s_stft, f_stft, t_stft] = stft(y_raw, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
figure(1);
subplot(2, 1, 1);
plot(t_raw, y_raw);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

% downsample
y_ds_5k = resample(y_raw, 5000, fs_raw);
audiowrite('./wave/ds_5k.wav', y_ds_5k, 5000);
l_ds_5k = length(y_ds_5k);
t_ds_5k = (1: l_ds_5k) ./ 5000;
[s_stft, f_stft, t_stft] = stft(y_ds_5k, 5000, 'Window', wd, 'OverlapLength', wl/2);
figure(2);
subplot(2, 1, 1);
plot(t_ds_5k, y_ds_5k);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

y_ds_10k = resample(y_raw, 10000, fs_raw);
audiowrite('./wave/ds_10k.wav', y_ds_10k, 10000);
l_ds_10k = length(y_ds_10k);
t_ds_10k = (1: l_ds_10k) ./ 10000;
[s_stft, f_stft, t_stft] = stft(y_ds_10k, 10000, 'Window', wd, 'OverlapLength', wl/2);
figure(3);
subplot(2, 1, 1);
plot(t_ds_10k, y_ds_10k);
xlim tight; xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

y_ds_15k = resample(y_raw, 15000, fs_raw);
audiowrite('./wave/ds_15k.wav', y_ds_15k, 15000);
l_ds_15k = length(y_ds_15k);
t_ds_15k = (1: l_ds_15k) ./ 15000;
[s_stft, f_stft, t_stft] = stft(y_ds_15k, 15000, 'Window', wd, 'OverlapLength', wl/2);
figure(4);
subplot(2, 1, 1);
plot(t_ds_15k, y_ds_15k);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

% recover
o_gitp = griddedInterpolant(t_ds_5k, y_ds_5k, 'pchip');
l_rc_5k = l_raw;
t_rc_5k = t_raw;
y_rc_5k = o_gitp(t_rc_5k);
y_rc_5k = y_rc_5k ./ max(y_rc_5k);
audiowrite('./wave/rc_5k.wav', y_rc_5k, fs_raw);
[s_stft, f_stft, t_stft] = stft(y_rc_5k, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
figure(5);
subplot(2, 1, 1);
plot(t_rc_5k, y_rc_5k);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

o_gitp = griddedInterpolant(t_ds_10k, y_ds_10k, 'pchip');
l_rc_10k = l_raw;
t_rc_10k = t_raw;
y_rc_10k = o_gitp(t_rc_10k);
y_rc_10k = y_rc_10k ./ max(y_rc_10k);
audiowrite('./wave/rc_10k.wav', y_rc_10k, fs_raw);
[s_stft, f_stft, t_stft] = stft(y_rc_10k, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
figure(6);
subplot(2, 1, 1);
plot(t_rc_10k, y_rc_10k);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

o_gitp = griddedInterpolant(t_ds_15k, y_ds_15k, 'pchip');
l_rc_15k = l_raw;
t_rc_15k = t_raw;
y_rc_15k = o_gitp(t_rc_15k);
y_rc_15k = y_rc_15k ./ max(y_rc_15k);
audiowrite('./wave/rc_15k.wav', y_rc_15k, fs_raw);
[s_stft, f_stft, t_stft] = stft(y_rc_15k, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
figure(7);
subplot(2, 1, 1);
plot(t_rc_15k, y_rc_15k);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_stft)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');

% equalize
co = [10, 10, 1, 1, 0.1, 0.1, 0.1];
[s_stft, f_stft, t_stft] = stft(y_raw, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
s_eq = s_stft .* equalizer(f_stft, co);
y_eq = istft(s_eq, fs_raw, 'Window', wd, 'OverlapLength', wl/2);
y_eq(1: 1024) = [];
y_eq(end-1023: end) = [];
y_eq = y_eq ./ max(abs(y_eq));
audiowrite('./wave/eq.wav', y_eq, fs_raw);
l_eq = length(y_eq);
t_eq = (1: l_eq) ./ fs_raw;
figure(8);
subplot(2, 1, 1);
plot(t_eq, y_eq);
xlim tight;
xlabel('time (s)');
ylabel('amplitude (mag)');
title('wave');
subplot(2, 1, 2);
imagesc(t_stft, f_stft, mag2db(abs(s_eq)));
xlabel('time (s)');
ylabel('frequency (db)');
title('spectrogram');